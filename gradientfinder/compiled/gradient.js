function Gradient(a,b,c){this._colorStops=[],this._alphaStops=[],this.angle=c||0==c?c:90,a=a||[];for(var d=0;a.length>d;d++)this.addColorStop(a[d].offset,a[d].color);b=b||[];for(var d=0;b.length>d;d++)this.addAlphaStop(b[d].offset,b[d].alpha)}Gradient.fromExportable=function(a){return new Gradient(a.colors.map(function(a){return{offset:a[0],color:tinycolor(a[1]).toRgbString()}}),a.alphas.map(function(a){return{offset:a[0],alpha:a[1]}}),a.angle)},Gradient.prototype.toExportable=function(){return{colors:this.getColorStops().map(function(a){return[a.getOffset(),tinycolor(a.color).toHex()]}),alphas:this.getAlphaStops().map(function(a){return[a.getOffset(),a.alpha]}),angle:this.angle}},Gradient.prototype.stopsToCSS=function(a,b){if(0===b.length)return"transparent";if(1===b.length)return[b[0].color];var d=b.map(function(a){return a.color+" "+Math.max(0,Math.min(parseInt(100*a.offset)))+"%"}),e=this.angleToCSSValue(a);return"linear-gradient("+e+", "+d.join(", ")+")"},Gradient.prototype.stopsToW3cCSS=function(a,b){if(0===b.length)return"transparent";if(1===b.length)return[b[0].color];var d=b.map(function(a){return a.color+" "+Math.max(0,Math.min(parseInt(100*a.offset)))+"%"}),e=this.angleToW3cCSSValue(a);return"linear-gradient("+e+", "+d.join(", ")+")"},Gradient.prototype.angleToW3cCSSValue=function(a){var b=a||this.angle;b===void 0&&(b="top"),0>b&&(b+=360);var c={0:"to right",90:"to top",180:"to left",270:"to bottom"},d=Math.abs(b-450)%360;return c[b]&&(b=c[b]),isNaN(parseInt(b))||(b=d+"deg"),b},Gradient.prototype.angleToCSSValue=function(a){var b=a||this.angle;b===void 0&&(b="top"),0>b&&(b+=360);var c={0:"left",90:"bottom",180:"right",270:"top"};return c[b]&&(b=c[b]),isNaN(parseInt(b))||(b+="deg"),b},Gradient.prototype.angleToGradientVector=function(){function b(a){return{x:Math.cos(a),y:Math.sin(a)}}function d(a){return a*Math.PI/180}var e=this.getAngle(),f=Math.pow(2,-52),g=e%360,h=b(d(180-g)),i=b(d(360-g));return 0>=h.x||f>=Math.abs(h.x)?h.x=0:(g>90&&180>g||g>270&&360>g)&&(h.x=parseFloat(h.x+.3)),0>=h.y||f>=Math.abs(h.y)?h.y=0:(g>90&&180>g||g>270&&360>g)&&(h.y=parseFloat(h.y+.3)),0>=i.x||f>=Math.abs(i.x)?i.x=0:(g>90&&180>g||g>270&&360>g)&&(i.x=parseFloat(i.x+.3)),0>=i.y||f>=Math.abs(i.y)?i.y=0:(g>90&&180>g||g>270&&360>g)&&(i.y=parseFloat(i.y+.3)),{x1:parseInt(100*h.x),y1:parseInt(100*h.y),x2:parseInt(100*i.x),y2:parseInt(100*i.y)}},Gradient.prototype.toCSSAlpha=function(a){var b=this.getAlphaStopsBlack();return 0===b.length&&(b=[{color:"#000",offset:1}]),this.stopsToCSS(a,b)},Gradient.prototype.toSVG=function(){var b=this.getAllStops(),c=b.map(function(a){return'<stop offset="'+a.percent+'" style="stop-color:'+a.color+";stop-opacity:"+a.alpha+';" />'}),d=this.angleToGradientVector(),e='x1="'+d.x1+'%" y1="'+d.y1+'%" x2="'+d.x2+'%" y2="'+d.y2+'%"';return['<linearGradient spreadMethod="pad" id="gradient" '+e+">",c.join("\n	"),"</linearGradient>"].join("\n")},Gradient.prototype.getAngle=function(){for(;0>this.angle;)this.angle+=360;return this.angle%360},Gradient.prototype.toCSSColor=function(a){return this.stopsToCSS(a,this.getColorStops())},Gradient.prototype.toCSS=function(a){return this.stopsToCSS(a,this.getAllStops())},Gradient.prototype.toW3cCSS=function(a){return this.stopsToW3cCSS(a,this.getAllStops())},Gradient.prototype.removeStop=function(a){this.removeColorStop(a),this.removeAlphaStop(a)},Gradient.prototype.removeColorStop=function(a){var b=this._colorStops.indexOf(a);-1!=b&&this._colorStops.splice(b,1)},Gradient.prototype.removeAlphaStop=function(a){var b=this._alphaStops.indexOf(a);-1!=b&&this._alphaStops.splice(b,1)},Gradient.prototype.getAllStops=function(){var a=this,b=this.getColorStops().map(function(b){var c=a.getInterpolatedAlphaAtOffset(b.offset),d=tinycolor(b.color);return d.setAlpha(c),{color:d.toString("rgb"),hex:d.toString("hex"),offset:b.offset,percent:b.getPercentOffset(),alpha:c}}),c=this.getAlphaStops().map(function(b){var c=tinycolor(a.getInterpolatedColorAtOffset(b.offset));return c.setAlpha(b.alpha),{color:c.toString("rgb"),hex:c.toString("hex"),offset:b.offset,percent:b.getPercentOffset(),alpha:b.alpha}});return 2>c.length&&(c=[]),b.concat(c).unique(function(a){return a.offset}).sort(function(a,b){return a.offset-b.offset})},Gradient.prototype.getColorStops=function(){return this._colorStops.sort(function(a,b){return a.offset-b.offset})},Gradient.prototype.getAlphaStops=function(){return this._alphaStops.sort(function(a,b){return a.offset-b.offset})},Gradient.prototype.getAlphaStopsBlack=function(){return this.getAlphaStops().map(function(a){return{color:"rgba(0, 0, 0, "+a.alpha+")",offset:Math.max(0,Math.min(1,a.offset))}})},Gradient.prototype.toCanvas=function(a,b,c,d){a=a||100,b=b||100;var e=document.createElement("canvas"),f=e.getContext("2d");e.width=a,e.height=b;var g={x1:0,x2:100,y1:0,y2:0};d||(g=this.angleToGradientVector(this.angle)),g.x1=g.x1/100*a,g.x2=g.x2/100*a,g.y1=g.y1/100*b,g.y2=g.y2/100*b;for(var h=f.createLinearGradient(g.x1,g.y1,g.x2,g.y2),i=c||this.getAllStops(),j=0;i.length>j;j++)h.addColorStop(Math.max(0,Math.min(1,i[j].offset)),i[j].color);return f.fillStyle=h,f.fillRect(0,0,a,b),e},Gradient.prototype.toCanvasRules=function(a,b){var c=this.angleToGradientVector(this.angle);c.x1=c.x1/100*a,c.x2=c.x2/100*a,c.y1=c.y1/100*b,c.y2=c.y2/100*b;var d=this.getAllStops().map(function(a){return"gradient.addColorStop("+Math.max(0,Math.min(1,a.offset))+', "'+a.color+'");'});return["var canvas = document.createElement('canvas');","var context = canvas.getContext('2d')","canvas.width = "+a+";","canvas.height = "+b+";","var gradient = context.createLinearGradient("+c.x1+", "+c.y1+", "+c.x2+", "+c.y2+");",d.join("\n"),"context.fillStyle = gradient;","context.fillRect(0, 0, "+a+", "+b+");"].join("\n")},Gradient.prototype.getInterpolatedColorAtOffset=function(a){var b=this.toCanvas(100,1,this.getColorStops(),!0),c=b.getContext("2d"),d=Math.max(0,Math.min(99,parseInt(100*a))),e=c.getImageData(d,0,1,1).data;return tinycolor({r:e[0],g:e[1],b:e[2]}).toHexString()},Gradient.prototype.getInterpolatedAlphaAtOffset=function(a){var b=this.getAlphaStopsBlack();if(0===b.length)return 1;var c=this.toCanvas(100,1,b,!0),d=c.getContext("2d"),e=Math.max(0,Math.min(99,parseInt(100*a))),f=d.getImageData(e,0,1,1).data;return Math.round(100*(f[3]/255))/100},Gradient.prototype.cloneStop=function(a,b){var c=a.offset,d=a.hasOwnProperty("alpha");if(b){var e=Math.random()/5,f=d?this.getAlphaStops():this.getColorStops(),g=f.indexOf(a),h=.5>c?c+e:c-e,i=g>0?f[g-1].offset:0,j=f.length-1>g?f[g+1].offset:1;Math.abs(c-h)<Math.abs(c-i)&&(h=i),Math.abs(c-h)<Math.abs(c-j)&&(h=j),c=(c+h)/2}return d?this.addAlphaStop(c,a.alpha):this.addColorStop(c,a.color)},Gradient.prototype.addColorStop=function(a,b){var c=tinycolor(b||this.getInterpolatedColorAtOffset(a));1>c.alpha&&(this.addAlphaStop(a,c.alpha),c.setAlpha(1));var d={offset:a,color:""+c,hex:c.toHexString(),getOffset:function(){return Math.min(1,Math.max(0,Math.round(100*this.offset)/100))},getPercentOffset:function(){return 100*d.getOffset()+"%"},setOffset:function(a){d.offset=Math.min(1,Math.max(0,a))}};return this._colorStops.push(d),this.getColorStops().indexOf(d)},Gradient.prototype.addAlphaStop=function(a,b){b=b||this.getInterpolatedAlphaAtOffset(a);var c={offset:a,alpha:b,getOffset:function(){return Math.min(1,Math.max(0,Math.round(100*this.offset)/100))},getPercentOffset:function(){return 100*c.getOffset()},setOffset:function(a){c.offset=Math.min(1,Math.max(0,a))}};return this._alphaStops.push(c),this.getAlphaStops().indexOf(c)},FreeStyle.GradientPicker=function(a){console.assert(a),a.addClass("gradient-picker"),this.gradient=new Gradient;var b=this;$("#track, #addstop").mousemove(function(a){$("#addstop").offset({left:a.pageX,top:$("#track").offset().top})}),$("#tracktop, #trackbottom").click(function(a){if(1===a.which){var c=(a.pageX-$(this).offset().left)/$(this).width(),d="trackbottom"==this.id,e=d?b.addColorStop(c):b.addAlphaStop(c);Generator.hardReload();var f=d?$("#stop-"+e):$("#alpha-"+e);return b.setActive(f),!1}}),$("#anglepicker").anglepicker({value:b.gradient.angle,change:function(a,c){b.gradient.angle=c.value,Generator.softReload()},start:function(){b.addUndoState()},stop:function(){$("#tip").hide()}}),$("#current-angle").change(function(){var a=parseInt($(this).val(),10);isNaN(a)||(b.gradient.angle=a,Generator.softReload())}),$("#gradient-type-tabs").tabs()},FreeStyle.GradientPicker.Events={Change:"Change",StateChange:"StateChange",StopAdded:"StopAdded",StopRemoved:"StopRemoved"},FreeStyle.GradientPicker.prototype=new FreeStyle.Object,$.extend(FreeStyle.GradientPicker.prototype,{addStop:function(){},toExportable:function(){return this.gradient.toExportable()},cloneStop:function(a){var b=this.gradient.cloneStop(a,!0);this.hardReload();var c=a.hasOwnProperty("color");c?this.setActive($("#stop-"+b)):this.setActive($("#alpha-"+b))},addUndoState:function(){this.dispatchEventToListeners(FreeStyle.GradientPicker.Events.StateChange)},addColorStop:function(a){return this.addUndoState(),this.gradient.addColorStop(a)},addAlphaStop:function(a){return this.addUndoState(),this.gradient.addAlphaStop(a)},removeStop:function(a){this.addUndoState(),this.gradient.removeStop(a),a.CONTAINER.remove(),Generator.softReload()},removeCurrentStop:function(){var a=this.getActive();return a.length?(a.find(".remove").click(),!0):!1},getAngle:function(){return this.gradient.angle},getActive:function(){return $(".stop.active")},setActive:function(a){$(".stop.active").removeClass("active").blur(),a.addClass("active");var b=a.find(".color");b.length&&b.spectrum("show")},hardReload:function(){function a(a,c){function e(a){return Math.round(a.getOffset()*d-f)}c.CONTAINER=a;var f=a.outerWidth(!0)/2,g=0,h=c.hasOwnProperty("alpha"),i=40,j=100;a.draggable({axis:"x",stack:".stop",snap:".guide",snapMode:"inner",snapTolerance:3,distance:2,start:function(a,c){Generator.setActive($(this)),g=c.offset.top,$(".active .color").spectrum("hide"),Generator.softReload(),b.addUndoState()},stop:function(b,g){c.offset=(g.position.left+f)/d,g.position.left=e(c),a.removeClass("almost-removed"),Generator.softReload()},drag:function(b,k){var l=k.offset.top-g;h&&(l=g-k.offset.top),l>i?a.addClass("almost-removed"):a.removeClass("almost-removed"),l>j?a.find("button.remove").click():(c.setOffset((k.position.left+f)/d),k.position.left=e(c)),Generator.softReload()}}),a.click(function(b){return $(b.target).is(".remove")?!1:(Generator.setActive(a),void 0)})}var b=this,c=this.gradient,d=$("#track").width();$(".stop").remove(),$.each(c.getAlphaStops(),function(c,d){var e=$("<div class='stop alpha' id='alpha-"+c+"' />").appendTo("#track");e.append("<div class='stop-handle' />"),e.append("<div class='alpha-slider-container'><div class='alpha-slider'></div><span class='label label-info label-alpha' /></div>"),e.append('<span class="label label-inverse label-offset" />'),e.data("stop",d),a(e,d);var f=e.find(".label-info"),g=parseInt(100*d.alpha);f.text(g+"%"),e.find(".alpha-slider").slider({min:0,max:100,orientation:"vertical",value:g,slide:function(a,b){d.alpha=b.value/100,f.text(b.value+"%"),Generator.softReload()}});var h=$("<button class='btn btn-inverse remove'><i class='icon-white icon-remove' /></button>").appendTo(e);h.click(function(){b.removeStop(d)})}),$.each(c.getColorStops(),function(c,d){var e=$("<div class='stop color' id='stop-"+c+"' />").appendTo("#track");e.append("<div class='stop-handle' />"),e.append('<span class="label label-inverse label-offset" />'),a(e,d),e.data("stop",d),$("<input class='color' />").appendTo(e).spectrum({color:d.color,showInput:!0,showSelection:!0,move:function(a){d.color=a.toHexString(),Generator.softReload(),$(this).spectrum("set",a)}}).bind("spectrum.movestart",function(){b.addUndoState()}).bind("spectrum.moveend",function(){});var g=($("<span class='inc' />").appendTo(e),$("<button class='btn btn-inverse remove'><i class='icon-white icon-remove' /></button>").appendTo(e));g.click(function(){b.removeStop(d)})}),Generator.softReload(),$("#anglepicker").anglepicker("value",c.angle)},softReload:function(){},loadFromExportable:function(a){try{var b=a;return"string"==typeof a&&(b=JSON.parse(a)),this.gradient=Gradient.fromExportable(b),this.hardReload(),!0}catch(c){}}});var UndoManager=function(){function a(){n||(n=$("#undo")),o||(o=$("#redo")),n.toggleClass("disabled",0==k.length),o.toggleClass("disabled",0==l.length)}function b(a){log("APPLYING STATE",a);var b=JSON.parse(a);App.onStateChange(b)}function c(){return JSON.stringify(App.getState())}function d(){var b=c(),d=b!==!1&&(0==k.length||k[k.length-1]!=b);d&&(k.push(b),k.length>m&&k.shift(),l.length,l.length=0,a())}function e(d){var e=d?k:l,f=d?l:k;if(e.length){var g=e.pop(),h=c();f.push(h),(0==e.length||1==f.length)&&a(),b(g)}}function f(){e(!0)}function g(){e(!1)}function h(){k=[],l=[],a()}function i(){return k}function j(){return l}var n,o,k=[],l=[],m=50;return{addState:d,undo:f,redo:g,clear:h,getUndoStack:i,getRedoStack:j}}();